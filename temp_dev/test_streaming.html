<!DOCTYPE html>
<html>
<head>
    <title>Streaming Test</title>
</head>
<body>
    <h1>AI Streaming Test</h1>
    <button onclick="testStreaming()">Test Streaming</button>
    <div id="output"></div>

    <script>
        async function testStreaming() {
            const output = document.getElementById('output');
            output.innerHTML = 'Testing streaming...<br>';
            
            try {
                const response = await fetch('http://localhost:4000/api/ai/generate-stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt: "What is the current status of the galaxy?",
                        character: {
                            name: "Chief Diplomatic Officer",
                            role: "diplomat",
                            department: "Foreign Affairs"
                        },
                        options: {
                            maxTokens: 200,
                            temperature: 0.7
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                if (data.type === 'text' && data.deltaText) {
                                    fullResponse += data.deltaText;
                                    output.innerHTML += `<span style="color: green;">${data.deltaText}</span>`;
                                } else if (data.type === 'end') {
                                    output.innerHTML += '<br><strong>Streaming completed!</strong><br>';
                                    output.innerHTML += `<br><strong>Full response:</strong><br>${fullResponse}`;
                                }
                            } catch (parseError) {
                                // Ignore parse errors for partial chunks
                            }
                        }
                    }
                }
            } catch (error) {
                output.innerHTML += `<br><span style="color: red;">Error: ${error.message}</span>`;
            }
        }
    </script>
</body>
</html>
