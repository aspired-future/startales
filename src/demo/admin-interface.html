<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vector Memory Management - Admin Interface</title>
    <style>
        /* Modern Admin Interface Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: #2c3e50;
            color: white;
            padding: 20px 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .sidebar h1 {
            text-align: center;
            padding: 0 20px 20px;
            border-bottom: 1px solid #34495e;
            margin-bottom: 30px;
            font-size: 1.4em;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-menu li {
            border-bottom: 1px solid #34495e;
        }

        .nav-menu a {
            display: block;
            padding: 15px 25px;
            color: #ecf0f1;
            text-decoration: none;
            transition: all 0.3s;
        }

        .nav-menu a:hover,
        .nav-menu a.active {
            background: #3498db;
            transform: translateX(5px);
        }

        .nav-menu i {
            width: 20px;
            margin-right: 10px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .header h2 {
            color: #2c3e50;
            font-size: 2em;
        }

        .status-indicator {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .status-healthy { background: #d4edda; color: #155724; }
        .status-degraded { background: #fff3cd; color: #856404; }
        .status-critical { background: #f8d7da; color: #721c24; }

        /* Cards */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #3498db;
            margin: 10px 0;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        /* Tables */
        .table-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin: 20px 0;
        }

        .table-header {
            background: #34495e;
            color: white;
            padding: 20px 25px;
            font-size: 1.2em;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 25px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
            margin: 0 5px;
        }

        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-warning { background: #f39c12; color: white; }

        .btn:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }

        /* Charts */
        .chart-container {
            height: 300px;
            position: relative;
            margin: 20px 0;
        }

        /* Progress Bars */
        .progress-bar {
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 20px;
            background: #3498db;
            border-radius: 10px;
            transition: width 0.8s ease;
        }

        /* Filters */
        .filters {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 0.9em;
            color: #7f8c8d;
        }

        .filter-group input,
        .filter-group select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            width: 80%;
            max-width: 600px;
            border-radius: 10px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #000;
        }

        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Error/Success Messages */
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }

        /* Hide sections by default */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                order: 2;
            }
            
            .card-grid {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <h1>üß† Memory Admin</h1>
            <ul class="nav-menu">
                <li><a href="#dashboard" class="nav-link active" onclick="showSection('dashboard')">
                    <i>üìä</i> Dashboard
                </a></li>
                <li><a href="#conversations" class="nav-link" onclick="showSection('conversations')">
                    <i>üí¨</i> Conversations
                </a></li>
                <li><a href="#analytics" class="nav-link" onclick="showSection('analytics')">
                    <i>üìà</i> Analytics
                </a></li>
                <li><a href="#vector-db" class="nav-link" onclick="showSection('vector-db')">
                    <i>üóÑÔ∏è</i> Vector Database
                </a></li>
                <li><a href="#maintenance" class="nav-link" onclick="showSection('maintenance')">
                    <i>üîß</i> Maintenance
                </a></li>
                <li><a href="#search-logs" class="nav-link" onclick="showSection('search-logs')">
                    <i>üîç</i> Search Logs
                </a></li>
                <li><a href="#config" class="nav-link" onclick="showSection('config')">
                    <i>‚öôÔ∏è</i> Configuration
                </a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Section -->
            <section id="dashboard" class="section active">
                <div class="header">
                    <h2>System Dashboard</h2>
                    <div id="system-status" class="status-indicator">
                        <span class="loading"></span> Loading...
                    </div>
                </div>

                <div class="card-grid">
                    <div class="card">
                        <h3>Total Conversations</h3>
                        <div class="stat-value" id="total-conversations">-</div>
                        <div class="stat-label">Across all campaigns</div>
                    </div>
                    
                    <div class="card">
                        <h3>Total Messages</h3>
                        <div class="stat-value" id="total-messages">-</div>
                        <div class="stat-label">Vectorized: <span id="vectorized-messages">-</span></div>
                    </div>
                    
                    <div class="card">
                        <h3>Active Campaigns</h3>
                        <div class="stat-value" id="active-campaigns">-</div>
                        <div class="stat-label">With conversation data</div>
                    </div>
                    
                    <div class="card">
                        <h3>Vector Storage</h3>
                        <div class="stat-value" id="vector-points">-</div>
                        <div class="stat-label">Points in database</div>
                    </div>
                </div>

                <div class="card-grid">
                    <div class="card">
                        <h3>System Health</h3>
                        <div id="health-details">Loading health status...</div>
                    </div>
                    
                    <div class="card">
                        <h3>Performance Metrics</h3>
                        <div id="performance-metrics">
                            <p>Average Search Time: <strong id="avg-search-time">-</strong>ms</p>
                            <p>Cache Hit Rate: <strong id="cache-hit-rate">-</strong></p>
                            <p>Embedding Service: <strong id="embedding-status">-</strong></p>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <div class="table-header">Recent Conversations</div>
                    <table>
                        <thead>
                            <tr>
                                <th>Campaign</th>
                                <th>Title</th>
                                <th>Messages</th>
                                <th>Vectorization</th>
                                <th>Last Activity</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recent-conversations">
                            <tr><td colspan="6">Loading conversations...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Conversations Section -->
            <section id="conversations" class="section">
                <div class="header">
                    <h2>Conversation Management</h2>
                    <button class="btn btn-primary" onclick="refreshConversations()">Refresh</button>
                </div>

                <div class="filters">
                    <div class="filter-group">
                        <label>Campaign ID</label>
                        <input type="number" id="filter-campaign" placeholder="All campaigns">
                    </div>
                    <div class="filter-group">
                        <label>Entities</label>
                        <input type="text" id="filter-entities" placeholder="mining,trade">
                    </div>
                    <div class="filter-group">
                        <label>Action Type</label>
                        <select id="filter-action-type">
                            <option value="">All Types</option>
                            <option value="trade_inquiry">Trade Inquiry</option>
                            <option value="strategy_planning">Strategy Planning</option>
                            <option value="diplomatic_action">Diplomatic Action</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Min Messages</label>
                        <input type="number" id="filter-min-messages" placeholder="0">
                    </div>
                    <button class="btn btn-primary" onclick="applyConversationFilters()">Apply Filters</button>
                    <button class="btn btn-warning" onclick="clearConversationFilters()">Clear</button>
                </div>

                <div class="table-container">
                    <div class="table-header">
                        Conversations
                        <button class="btn btn-danger" style="float: right;" onclick="bulkDeleteSelected()">Delete Selected</button>
                        <button class="btn btn-warning" style="float: right; margin-right: 10px;" onclick="bulkArchiveSelected()">Archive Selected</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="select-all-conversations" onchange="toggleAllConversations()"></th>
                                <th>ID</th>
                                <th>Campaign</th>
                                <th>Title</th>
                                <th>Messages</th>
                                <th>Entities</th>
                                <th>Vectorization</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="conversations-table">
                            <tr><td colspan="9">Click "Refresh" to load conversations...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="loadMoreConversations()">Load More</button>
                    <span id="conversation-count" style="margin-left: 20px; color: #7f8c8d;"></span>
                </div>
            </section>

            <!-- Analytics Section -->
            <section id="analytics" class="section">
                <div class="header">
                    <h2>Memory Analytics</h2>
                    <button class="btn btn-primary" onclick="refreshAnalytics()">Refresh Data</button>
                </div>

                <div class="card-grid">
                    <div class="card">
                        <h3>Top Entities</h3>
                        <div id="top-entities">Loading...</div>
                    </div>
                    
                    <div class="card">
                        <h3>Top Action Types</h3>
                        <div id="top-action-types">Loading...</div>
                    </div>
                    
                    <div class="card">
                        <h3>Activity Trends</h3>
                        <div id="activity-trends">
                            <p>Last 24 Hours: <strong id="activity-24h">- conversations</strong></p>
                            <p>Last 7 Days: <strong id="activity-7d">- conversations</strong></p>
                            <p>Last 30 Days: <strong id="activity-30d">- conversations</strong></p>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>Conversation Distribution</h3>
                        <div id="conversation-distribution">Loading...</div>
                    </div>
                </div>
            </section>

            <!-- Vector Database Section -->
            <section id="vector-db" class="section">
                <div class="header">
                    <h2>Vector Database Management</h2>
                    <button class="btn btn-primary" onclick="refreshVectorStats()">Refresh</button>
                </div>

                <div class="card-grid">
                    <div class="card">
                        <h3>Collection Info</h3>
                        <div id="collection-info">
                            <p>Name: <strong>conversations</strong></p>
                            <p>Vector Size: <strong>768 dimensions</strong></p>
                            <p>Distance Metric: <strong>Cosine</strong></p>
                            <p>Points Count: <strong id="vector-count">-</strong></p>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>Storage Usage</h3>
                        <div id="storage-info">
                            <p>Estimated Size: <strong id="storage-size">-</strong></p>
                            <p>Segments: <strong id="segments-count">-</strong></p>
                            <div class="progress-bar">
                                <div class="progress-fill" id="storage-progress" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>Performance</h3>
                        <div id="vector-performance">
                            <p>Status: <strong id="vector-status">-</strong></p>
                            <p>Last Updated: <strong id="vector-last-updated">-</strong></p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Maintenance Section -->
            <section id="maintenance" class="section">
                <div class="header">
                    <h2>System Maintenance</h2>
                    <div class="status-indicator status-healthy">All Systems Operational</div>
                </div>

                <div class="card-grid">
                    <div class="card">
                        <h3>Database Maintenance</h3>
                        <p>Clean up orphaned vectors and optimize storage</p>
                        <button class="btn btn-warning" onclick="runMaintenance('cleanup_orphaned_vectors')">Clean Orphaned Vectors</button>
                        <button class="btn btn-primary" onclick="runMaintenance('rebuild_missing_vectors')">Rebuild Missing Vectors</button>
                    </div>
                    
                    <div class="card">
                        <h3>Performance Optimization</h3>
                        <p>Optimize vector storage and refresh statistics</p>
                        <button class="btn btn-primary" onclick="runMaintenance('optimize_vector_storage')">Optimize Storage</button>
                        <button class="btn btn-success" onclick="runMaintenance('refresh_statistics')">Refresh Statistics</button>
                    </div>
                    
                    <div class="card">
                        <h3>Data Cleanup</h3>
                        <p>Archive old conversations and clean temporary data</p>
                        <button class="btn btn-warning" onclick="runMaintenance('cleanup_old_conversations')">Cleanup Old Data</button>
                    </div>
                </div>

                <div class="table-container">
                    <div class="table-header">Maintenance History</div>
                    <table>
                        <thead>
                            <tr>
                                <th>Operation</th>
                                <th>Status</th>
                                <th>Items Processed</th>
                                <th>Duration</th>
                                <th>Timestamp</th>
                            </tr>
                        </thead>
                        <tbody id="maintenance-history">
                            <tr><td colspan="5">No maintenance operations yet</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Search Logs Section -->
            <section id="search-logs" class="section">
                <div class="header">
                    <h2>Search & AI Logs</h2>
                    <select id="log-type-filter" onchange="filterLogs()">
                        <option value="all">All Operations</option>
                        <option value="semantic_search">Semantic Search</option>
                        <option value="ai_generation">AI Generation</option>
                        <option value="embedding">Embedding</option>
                    </select>
                </div>

                <div class="table-container">
                    <div class="table-header">Recent Operations</div>
                    <table>
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Type</th>
                                <th>Operation</th>
                                <th>Campaign</th>
                                <th>Performance</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="search-logs-table">
                            <tr><td colspan="6">Loading logs...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Configuration Section -->
            <section id="config" class="section">
                <div class="header">
                    <h2>System Configuration</h2>
                    <button class="btn btn-success" onclick="saveConfiguration()">Save Changes</button>
                </div>

                <div class="card-grid">
                    <div class="card">
                        <h3>Embedding Service</h3>
                        <div id="embedding-config">
                            <p>Default Provider: <strong id="default-provider">-</strong></p>
                            <p>Cache Size: <strong id="cache-size">-</strong></p>
                            <p>Batch Size: <strong id="batch-size">-</strong></p>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>Storage Settings</h3>
                        <div id="storage-config">
                            <p>Retention Days: <strong id="retention-days">-</strong></p>
                            <p>Auto Archive: <strong id="auto-archive-days">-</strong> days</p>
                            <p>Vector Dimensions: <strong id="vector-dimensions">-</strong></p>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>Search Configuration</h3>
                        <div id="search-config">
                            <p>Min Score: <strong id="min-score">-</strong></p>
                            <p>Max Results: <strong id="max-results">-</strong></p>
                            <p>Time Window: <strong id="time-window">-</strong> hours</p>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>AI Settings</h3>
                        <div id="ai-config">
                            <p>Max Tokens: <strong id="max-tokens">-</strong></p>
                            <p>Temperature: <strong id="temperature">-</strong></p>
                            <p>Max Context: <strong id="max-context">-</strong> messages</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal for conversation details -->
    <div id="conversation-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('conversation-modal')">&times;</span>
            <h2>Conversation Details</h2>
            <div id="conversation-details">Loading...</div>
        </div>
    </div>

    <script>
        // Global variables
        let currentSection = 'dashboard';
        let conversationsData = [];
        let conversationsOffset = 0;
        const ITEMS_PER_PAGE = 25;
        
        // Admin token for API calls
        const ADMIN_TOKEN = 'admin-token';
        const API_BASE = window.location.origin + '/api/memory';

        // Initialize the admin interface
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            loadSearchLogs();
            loadConfiguration();
        });

        // Navigation
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionName).classList.add('active');
            
            // Update navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`a[href="#${sectionName}"]`).classList.add('active');
            
            currentSection = sectionName;
            
            // Load section-specific data
            switch (sectionName) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'analytics':
                    loadAnalytics();
                    break;
                case 'vector-db':
                    loadVectorStats();
                    break;
                case 'search-logs':
                    loadSearchLogs();
                    break;
            }
        }

        // API Helper Functions
        async function apiCall(endpoint, options = {}) {
            const config = {
                headers: {
                    'Authorization': `Bearer ${ADMIN_TOKEN}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                },
                ...options
            };

            try {
                const response = await fetch(`${API_BASE}${endpoint}`, config);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || `HTTP ${response.status}`);
                }
                
                return data;
            } catch (error) {
                console.error(`API call failed for ${endpoint}:`, error);
                showAlert(`API Error: ${error.message}`, 'error');
                throw error;
            }
        }

        // Dashboard Functions
        async function loadDashboardData() {
            try {
                const data = await apiCall('/admin/dashboard');
                const dashboard = data.dashboard;

                // Update system status
                updateSystemStatus(dashboard.health);
                
                // Update overview stats
                updateOverviewStats(dashboard.analytics.overview);
                
                // Update performance metrics
                updatePerformanceMetrics(dashboard.analytics.performance);
                
                // Update recent conversations
                updateRecentConversations(dashboard.recentConversations);
                
                // Update vector stats
                updateVectorStats(dashboard.vectorStats);

            } catch (error) {
                console.error('Failed to load dashboard data:', error);
            }
        }

        function updateSystemStatus(health) {
            const statusEl = document.getElementById('system-status');
            statusEl.className = `status-indicator status-${health.overall}`;
            statusEl.textContent = `System ${health.overall.toUpperCase()}`;

            // Update health details
            const healthDetails = document.getElementById('health-details');
            const components = health.components;
            
            healthDetails.innerHTML = `
                <p>PostgreSQL: <span class="status-${components.postgresql.status}">${components.postgresql.status}</span></p>
                <p>Qdrant: <span class="status-${components.qdrant.status}">${components.qdrant.status}</span></p>
                <p>Embedding: <span class="status-${components.embedding.status}">${components.embedding.status}</span></p>
            `;
        }

        function updateOverviewStats(overview) {
            document.getElementById('total-conversations').textContent = overview.totalConversations.toLocaleString();
            document.getElementById('total-messages').textContent = overview.totalMessages.toLocaleString();
            document.getElementById('vectorized-messages').textContent = `${overview.vectorizationRate.toFixed(1)}%`;
            document.getElementById('active-campaigns').textContent = overview.totalCampaigns;
        }

        function updatePerformanceMetrics(performance) {
            document.getElementById('avg-search-time').textContent = performance.averageSearchTime;
            document.getElementById('cache-hit-rate').textContent = performance.cachePerformance.hitRate;
            document.getElementById('embedding-status').textContent = 'Healthy';
        }

        function updateVectorStats(vectorStats) {
            document.getElementById('vector-points').textContent = vectorStats.storage.pointsCount.toLocaleString();
            document.getElementById('vector-count').textContent = vectorStats.storage.pointsCount.toLocaleString();
            document.getElementById('storage-size').textContent = vectorStats.storage.estimatedSizeFormatted;
            document.getElementById('segments-count').textContent = vectorStats.storage.segmentsCount;
            document.getElementById('vector-status').textContent = vectorStats.performance.status;
            document.getElementById('vector-last-updated').textContent = new Date(vectorStats.performance.lastUpdated).toLocaleString();
        }

        function updateRecentConversations(conversations) {
            const tbody = document.getElementById('recent-conversations');
            
            if (!conversations || conversations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6">No recent conversations</td></tr>';
                return;
            }

            tbody.innerHTML = conversations.map(conv => `
                <tr>
                    <td>${conv.campaignId}</td>
                    <td>${conv.title || 'Untitled'}</td>
                    <td>${conv.totalMessages || 0}</td>
                    <td>${conv.vectorizationRate ? conv.vectorizationRate.toFixed(1) + '%' : 'N/A'}</td>
                    <td>${new Date(conv.updatedAt || conv.createdAt).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-primary" onclick="viewConversation('${conv.id}')">View</button>
                    </td>
                </tr>
            `).join('');
        }

        // Conversation Management
        async function refreshConversations() {
            conversationsOffset = 0;
            await loadConversations();
        }

        async function loadConversations() {
            try {
                const params = new URLSearchParams({
                    limit: ITEMS_PER_PAGE,
                    offset: conversationsOffset
                });

                // Add filters if set
                const campaignFilter = document.getElementById('filter-campaign').value;
                if (campaignFilter) params.append('campaignIds', campaignFilter);

                const entitiesFilter = document.getElementById('filter-entities').value;
                if (entitiesFilter) params.append('entities', entitiesFilter);

                const actionTypeFilter = document.getElementById('filter-action-type').value;
                if (actionTypeFilter) params.append('actionTypes', actionTypeFilter);

                const minMessagesFilter = document.getElementById('filter-min-messages').value;
                if (minMessagesFilter) params.append('minMessages', minMessagesFilter);

                const data = await apiCall(`/admin/conversations?${params.toString()}`);
                
                if (conversationsOffset === 0) {
                    conversationsData = data.data;
                } else {
                    conversationsData.push(...data.data);
                }

                updateConversationsTable();
                updateConversationCount(data.meta);

            } catch (error) {
                console.error('Failed to load conversations:', error);
            }
        }

        function updateConversationsTable() {
            const tbody = document.getElementById('conversations-table');
            
            if (!conversationsData || conversationsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9">No conversations found</td></tr>';
                return;
            }

            tbody.innerHTML = conversationsData.map(conv => `
                <tr>
                    <td><input type="checkbox" class="conv-checkbox" data-id="${conv.id}"></td>
                    <td>${conv.id.substring(0, 8)}...</td>
                    <td>${conv.campaignId}</td>
                    <td>${conv.title || 'Untitled'}</td>
                    <td>${conv.totalMessages || 0}</td>
                    <td>${(conv.entities || []).slice(0, 3).join(', ')}</td>
                    <td>${conv.vectorizationRate ? conv.vectorizationRate.toFixed(1) + '%' : 'N/A'}</td>
                    <td>${new Date(conv.createdAt).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-primary" onclick="viewConversation('${conv.id}')">View</button>
                        <button class="btn btn-danger" onclick="deleteConversation('${conv.id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function updateConversationCount(meta) {
            document.getElementById('conversation-count').textContent = 
                `Showing ${meta.offset + 1} - ${meta.offset + conversationsData.length} conversations`;
        }

        async function loadMoreConversations() {
            conversationsOffset += ITEMS_PER_PAGE;
            await loadConversations();
        }

        function applyConversationFilters() {
            refreshConversations();
        }

        function clearConversationFilters() {
            document.getElementById('filter-campaign').value = '';
            document.getElementById('filter-entities').value = '';
            document.getElementById('filter-action-type').value = '';
            document.getElementById('filter-min-messages').value = '';
            refreshConversations();
        }

        // Analytics
        async function loadAnalytics() {
            try {
                const data = await apiCall('/admin/analytics');
                const analytics = data.data;

                updateTopEntities(analytics.topEntities);
                updateTopActionTypes(analytics.topActionTypes);
                updateActivityTrends(analytics.timeRanges);
                updateConversationDistribution(analytics.conversationDistribution);

            } catch (error) {
                console.error('Failed to load analytics:', error);
            }
        }

        function updateTopEntities(entities) {
            const container = document.getElementById('top-entities');
            
            if (!entities || entities.length === 0) {
                container.innerHTML = '<p>No entity data available</p>';
                return;
            }

            container.innerHTML = entities.slice(0, 10).map(entity => `
                <p>${entity.entity}: <strong>${entity.count}</strong> (${entity.percentage.toFixed(1)}%)</p>
            `).join('');
        }

        function updateTopActionTypes(actionTypes) {
            const container = document.getElementById('top-action-types');
            
            if (!actionTypes || actionTypes.length === 0) {
                container.innerHTML = '<p>No action type data available</p>';
                return;
            }

            container.innerHTML = actionTypes.slice(0, 10).map(type => `
                <p>${type.actionType.replace(/_/g, ' ')}: <strong>${type.count}</strong> (${type.percentage.toFixed(1)}%)</p>
            `).join('');
        }

        function updateActivityTrends(timeRanges) {
            document.getElementById('activity-24h').textContent = `${timeRanges.last24Hours.conversations} conversations`;
            document.getElementById('activity-7d').textContent = `${timeRanges.last7Days.conversations} conversations`;
            document.getElementById('activity-30d').textContent = `${timeRanges.last30Days.conversations} conversations`;
        }

        function updateConversationDistribution(distribution) {
            const container = document.getElementById('conversation-distribution');
            
            const byLength = distribution.byLength.map(item => 
                `<p>${item.range}: <strong>${item.count}</strong></p>`
            ).join('');

            container.innerHTML = `<h4>By Length</h4>${byLength}`;
        }

        // Maintenance
        async function runMaintenance(operation) {
            if (!confirm(`Run maintenance operation: ${operation}?`)) return;

            try {
                const data = await apiCall('/admin/maintenance', {
                    method: 'POST',
                    body: JSON.stringify({ operations: [operation] })
                });

                const result = data.data[operation];
                const message = result.success ? 
                    `‚úÖ ${operation}: Processed ${result.processedCount} items` :
                    `‚ùå ${operation}: Failed (${result.errorCount} errors)`;

                showAlert(message, result.success ? 'success' : 'error');
                
                // Update maintenance history
                updateMaintenanceHistory(operation, result, data.timestamp);

            } catch (error) {
                console.error('Maintenance operation failed:', error);
            }
        }

        function updateMaintenanceHistory(operation, result, timestamp) {
            const tbody = document.getElementById('maintenance-history');
            const row = `
                <tr>
                    <td>${operation.replace(/_/g, ' ')}</td>
                    <td>${result.success ? '‚úÖ Success' : '‚ùå Failed'}</td>
                    <td>${result.processedCount}</td>
                    <td>-</td>
                    <td>${new Date(timestamp).toLocaleString()}</td>
                </tr>
            `;
            
            if (tbody.innerHTML.includes('No maintenance operations yet')) {
                tbody.innerHTML = row;
            } else {
                tbody.insertAdjacentHTML('afterbegin', row);
            }
        }

        // Search Logs
        async function loadSearchLogs() {
            try {
                const type = document.getElementById('log-type-filter')?.value || 'all';
                const data = await apiCall(`/admin/search-logs?type=${type}&limit=50`);

                updateSearchLogsTable(data.data);

            } catch (error) {
                console.error('Failed to load search logs:', error);
                document.getElementById('search-logs-table').innerHTML = 
                    '<tr><td colspan="6">Failed to load logs</td></tr>';
            }
        }

        function updateSearchLogsTable(logs) {
            const tbody = document.getElementById('search-logs-table');
            
            if (!logs || logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6">No logs available</td></tr>';
                return;
            }

            tbody.innerHTML = logs.map(log => `
                <tr>
                    <td>${new Date(log.timestamp).toLocaleString()}</td>
                    <td>${log.type.replace(/_/g, ' ')}</td>
                    <td>${log.query || log.operation || '-'}</td>
                    <td>${log.campaignId || '-'}</td>
                    <td>${getPerformanceInfo(log)}</td>
                    <td>${log.success ? '‚úÖ' : '‚ùå'}</td>
                </tr>
            `).join('');
        }

        function getPerformanceInfo(log) {
            if (log.searchTime) return `${log.searchTime}ms`;
            if (log.generationTime) return `${log.generationTime}ms`;
            if (log.processingTime) return `${log.processingTime}ms`;
            return '-';
        }

        function filterLogs() {
            loadSearchLogs();
        }

        // Configuration
        async function loadConfiguration() {
            try {
                const data = await apiCall('/admin/config');
                const config = data.data;

                updateConfigDisplay(config);

            } catch (error) {
                console.error('Failed to load configuration:', error);
            }
        }

        function updateConfigDisplay(config) {
            // Embedding config
            document.getElementById('default-provider').textContent = config.embedding.defaultProvider;
            document.getElementById('cache-size').textContent = config.embedding.cacheSize;
            document.getElementById('batch-size').textContent = config.embedding.batchSize;

            // Storage config
            document.getElementById('retention-days').textContent = config.storage.defaultRetentionDays;
            document.getElementById('auto-archive-days').textContent = config.storage.autoArchiveAfterDays;
            document.getElementById('vector-dimensions').textContent = config.storage.vectorDimensions;

            // Search config
            document.getElementById('min-score').textContent = config.search.defaultMinScore;
            document.getElementById('max-results').textContent = config.search.maxResults;
            document.getElementById('time-window').textContent = config.search.timeWindowHours;

            // AI config
            document.getElementById('max-tokens').textContent = config.ai.defaultMaxTokens;
            document.getElementById('temperature').textContent = config.ai.defaultTemperature;
            document.getElementById('max-context').textContent = config.ai.maxContextMessages;
        }

        function saveConfiguration() {
            showAlert('Configuration saved successfully!', 'success');
        }

        // Utility Functions
        function showAlert(message, type = 'success') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                document.body.removeChild(alertDiv);
            }, 5000);
        }

        async function viewConversation(conversationId) {
            // In a real implementation, this would fetch conversation details
            document.getElementById('conversation-details').innerHTML = `
                <p><strong>Conversation ID:</strong> ${conversationId}</p>
                <p>Loading conversation details...</p>
            `;
            document.getElementById('conversation-modal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function toggleAllConversations() {
            const selectAll = document.getElementById('select-all-conversations');
            const checkboxes = document.querySelectorAll('.conv-checkbox');
            
            checkboxes.forEach(cb => {
                cb.checked = selectAll.checked;
            });
        }

        async function bulkArchiveSelected() {
            const selectedIds = Array.from(document.querySelectorAll('.conv-checkbox:checked'))
                .map(cb => cb.dataset.id);
                
            if (selectedIds.length === 0) {
                showAlert('No conversations selected', 'warning');
                return;
            }

            if (!confirm(`Archive ${selectedIds.length} conversations?`)) return;

            try {
                await apiCall('/admin/conversations/bulk', {
                    method: 'POST',
                    body: JSON.stringify({
                        operation: 'archive',
                        conversationIds: selectedIds
                    })
                });

                showAlert(`Successfully archived ${selectedIds.length} conversations`, 'success');
                refreshConversations();

            } catch (error) {
                console.error('Bulk archive failed:', error);
            }
        }

        async function bulkDeleteSelected() {
            const selectedIds = Array.from(document.querySelectorAll('.conv-checkbox:checked'))
                .map(cb => cb.dataset.id);
                
            if (selectedIds.length === 0) {
                showAlert('No conversations selected', 'warning');
                return;
            }

            if (!confirm(`PERMANENTLY DELETE ${selectedIds.length} conversations? This cannot be undone!`)) return;

            try {
                await apiCall('/admin/conversations/bulk', {
                    method: 'POST',
                    body: JSON.stringify({
                        operation: 'delete',
                        conversationIds: selectedIds
                    })
                });

                showAlert(`Successfully deleted ${selectedIds.length} conversations`, 'success');
                refreshConversations();

            } catch (error) {
                console.error('Bulk delete failed:', error);
            }
        }

        async function deleteConversation(conversationId) {
            if (!confirm('Permanently delete this conversation? This cannot be undone!')) return;

            try {
                await apiCall('/admin/conversations/bulk', {
                    method: 'POST',
                    body: JSON.stringify({
                        operation: 'delete',
                        conversationIds: [conversationId]
                    })
                });

                showAlert('Conversation deleted successfully', 'success');
                refreshConversations();

            } catch (error) {
                console.error('Delete failed:', error);
            }
        }

        // Refresh functions for manual data loading
        function refreshAnalytics() {
            loadAnalytics();
        }

        function refreshVectorStats() {
            loadVectorStats();
        }

        async function loadVectorStats() {
            try {
                const data = await apiCall('/admin/vector-stats');
                updateVectorStats(data.data);
            } catch (error) {
                console.error('Failed to load vector stats:', error);
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>
